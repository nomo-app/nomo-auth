"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("moment"),e=require("jsonwebtoken"),o=require("crypto"),n=require("bitcoinjs-message");function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=r(t),a=r(e),s=r(o),u=r(n);function _(t,e,o,n){return new(o||(o=Promise))((function(r,i){function a(t){try{u(n.next(t))}catch(t){i(t)}}function s(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(a,s)}u((n=n.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class c extends Error{constructor(t,e){super(e),this.message=e,this.status_code=t}}function d(t){var e;return{authorization:null!==(e=t.header("authorization"))&&void 0!==e?e:t.header("Authorization"),nomo_auth_addr:t.header("nomo-auth-addr"),nomo_auth_version:t.header("nomo-auth-version"),nomo_sig:t.header("nomo-sig")}}let h=null;const f={nomo_jwt_secret_key:"",nomo_jwt_validity_in_sec:10800,nomo_ignore_signature:!1},m={messagePrefix:"Eurocoin Signed Message:\n",bip32:{public:76067358,private:76066276},pubKeyHash:87,scriptHash:88,wif:128,dustThreshold:1};function l(t){try{return t?a.default.verify(t,null==h?void 0:h.nomo_jwt_secret_key):null}catch(t){return null}}exports.getNomoHeaderData=d,exports.getNomoToken=function(t){var e;const o=null===(e=d(t).authorization)||void 0===e?void 0:e.slice(7);if(!o)throw new c(403,"AUTH_TOKEN_INVALID");const n=l(o);if(!n)throw new c(403,"AUTH_TOKEN_INVALID");return n},exports.nomoMiddleware=function(t){return h=Object.assign(Object.assign({},f),t),h.nomo_jwt_secret_key,function(t,e,o){return _(this,void 0,void 0,(function*(){try{t.header("nomo-auth-addr")||o(),function(t,e){const o=d(t);if(!o.nomo_auth_version)throw new c(403,"NOMO_MISSING_AUTH_VERSION");if(!o.authorization)throw new c(403,"NOMO_MISSING_AUTHORIZATION_TOKEN");if(!o.nomo_sig)throw new c(403,"NOMO_MISSING_SIGNATURE");const n=o.authorization.slice(7);if(!n)throw new c(403,"AUTH_TOKEN_INVALID");const r=l(n);if(!r)throw new c(403,"AUTH_TOKEN_INVALID");if(!r.timestamp||!r.nomo_auth_addr||!r.nonce)throw new c(403,"AUTH_TOKEN_INVALID");if(!(null==e?void 0:e.nomo_jwt_validity_in_sec)||r.timestamp+e.nomo_jwt_validity_in_sec<i.default().utc().unix())throw new c(403,"AUTH_TOKEN_EXPIRED");if(o.nomo_auth_addr!==r.nomo_auth_addr)throw new c(403,"NOMO_INVALID_AUTH_ADDR");if(!(null==e?void 0:e.nomo_ignore_signature)&&!function(t,e,o){try{return u.default.verify(o,t,e,m.messagePrefix)}catch(t){return!1}}(o.nomo_auth_addr,o.nomo_sig,n))throw new c(403,"NOMO_INVALID_SIGNATURE")}(t,h),o()}catch(o){if(o instanceof c){const n={error_message:o.message,error_type:"API_ERROR"},r=d(t);if(403===o.status_code&&r.nomo_auth_addr){const t=s.default.randomBytes(15).toString("hex"),e=i.default().utc().unix(),o={nomo_auth_addr:r.nomo_auth_addr,nonce:t,timestamp:e};n.jwt=a.default.sign(o,null==h?void 0:h.nomo_jwt_secret_key)}e.status(o.status_code).json(n)}else console.log(o),e.status(500).json({error_message:o,error_type:"INTERNAL_ERROR"});e.end()}}))}};
//# sourceMappingURL=index.js.map
