import o from"jsonwebtoken";import n from"crypto";import t from"moment";import e from"bitcoinjs-message";function r(o,n,t,e){return new(t||(t=Promise))((function(r,s){function _(o){try{u(e.next(o))}catch(o){s(o)}}function i(o){try{u(e.throw(o))}catch(o){s(o)}}function u(o){var n;o.done?r(o.value):(n=o.value,n instanceof t?n:new t((function(o){o(n)}))).then(_,i)}u((e=e.apply(o,n||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class s extends Error{constructor(o,n){super(n),this.message=n,this.status_code=o}}function _(o){var n,t,e;const r=null!==(n=o.header("authorization"))&&void 0!==n?n:o.header("Authorization"),s={nomo_token:null==r?void 0:r.slice(7),nomo_auth_addr:o.header("nomo-auth-addr"),nomo_auth_version:o.header("nomo-auth-version"),nomo_sig:o.header("nomo-sig"),nomo_version:null===(t=o.header("User-Agent"))||void 0===t?void 0:t.slice(5),nomo_language:o.header("Accept-Language")},_=null===(e=o.header("nomo-plugin"))||void 0===e?void 0:e.split("/");return 2===(null==_?void 0:_.length)&&(s.nomo_plugin_name=_[0],s.nomo_plugin_version=_[1]),s}function i(e,r){const s=_(e),i=n.randomBytes(15).toString("hex"),u=t().utc().unix(),a={nomo_auth_addr:s.nomo_auth_addr,nonce:i,timestamp:u};return o.sign(a,r.nomo_token_secret)}function u(n,r){const i=_(n);if(!i.nomo_token)throw new s(403,"NOMO_AUTH_TOKEN_INVALID");const u=function(n,t){try{return n?o.verify(n,t.nomo_token_secret):null}catch(o){return null}}(i.nomo_token,r);if(!u)throw new s(403,"NOMO_AUTH_TOKEN_INVALID");if(!u.timestamp||!u.nomo_auth_addr||!u.nonce)throw new s(403,"NOMO_AUTH_TOKEN_INVALID");if(u.timestamp+r.nomo_token_validity<t().utc().unix())throw new s(403,"NOMO_AUTH_TOKEN_EXPIRED");if(i.nomo_auth_addr!==u.nomo_auth_addr)throw new s(403,"NOMO_INVALID_AUTH_ADDR");const a=function(o,n,t){if(!o||!n||!t)return!1;try{return e.verify(t,o,n,"Eurocoin Signed Message:\n")}catch(o){return!1}}(i.nomo_auth_addr,i.nomo_sig,i.nomo_token);if(!r.nomo_browser_dev_mode&&!a)throw new s(403,"NOMO_INVALID_SIGNATURE")}const a={nomo_token_secret:"",nomo_token_validity:10800,nomo_browser_dev_mode:!1};function c(o){const n=((t=o).nomo_token_secret,Object.assign(Object.assign({},a),t));var t;return function(o,t,e){return r(this,void 0,void 0,(function*(){try{if(!o.header("nomo-auth-addr"))return void e();!function(o){const n=_(o);if(!n.nomo_token)throw new s(403,"NOMO_AUTH_TOKEN_INVALID");n.nomo_auth_version||new s(403,"NOMO_MISSING_AUTH_VERSION"),n.nomo_token||new s(403,"NOMO_MISSING_AUTHORIZATION_TOKEN"),n.nomo_sig||new s(403,"NOMO_MISSING_SIGNATURE")}(o),u(o,n),e()}catch(e){const r=function(o,n,t,e){if(t instanceof s){const r={error_message:t.message,error_type:"API_ERROR"};return 403===t.status_code&&(r.jwt=e(o,n)),{status:t.status_code,response:r}}return{status:500,response:{error_message:t,error_type:"INTERNAL_ERROR"}}}(o,n,e,i);t.status(r.status).json(r.response),t.end()}}))}}export{_ as getNomoHeaderData,c as nomoMiddleware};
//# sourceMappingURL=index.js.map
