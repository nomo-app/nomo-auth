import o from"moment";import t from"jsonwebtoken";import n from"crypto";import e from"bitcoinjs-message";function r(o,t,n,e){return new(n||(n=Promise))((function(r,i){function s(o){try{a(e.next(o))}catch(o){i(o)}}function _(o){try{a(e.throw(o))}catch(o){i(o)}}function a(o){var t;o.done?r(o.value):(t=o.value,t instanceof n?t:new n((function(o){o(t)}))).then(s,_)}a((e=e.apply(o,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class i extends Error{constructor(o,t){super(t),this.message=t,this.status_code=o}}function s(o){var t;const n=null===(t=_(o).authorization)||void 0===t?void 0:t.slice(7);if(!n)throw new i(403,"AUTH_TOKEN_INVALID");const e=m(n);if(!e)throw new i(403,"AUTH_TOKEN_INVALID");return e}function _(o){var t;return{authorization:null!==(t=o.header("authorization"))&&void 0!==t?t:o.header("Authorization"),nomo_auth_addr:o.header("nomo-auth-addr"),nomo_auth_version:o.header("nomo-auth-version"),nomo_sig:o.header("nomo-sig")}}let a=null;function u(s){return a=Object.assign(Object.assign({},c),s),a.nomo_jwt_secret_key,function(s,u,c){return r(this,void 0,void 0,(function*(){try{s.header("nomo-auth-addr")||c(),function(t,n){const r=_(t);if(!r.nomo_auth_version)throw new i(403,"NOMO_MISSING_AUTH_VERSION");if(!r.authorization)throw new i(403,"NOMO_MISSING_AUTHORIZATION_TOKEN");if(!r.nomo_sig)throw new i(403,"NOMO_MISSING_SIGNATURE");const s=r.authorization.slice(7);if(!s)throw new i(403,"AUTH_TOKEN_INVALID");const a=m(s);if(!a)throw new i(403,"AUTH_TOKEN_INVALID");if(!a.timestamp||!a.nomo_auth_addr||!a.nonce)throw new i(403,"AUTH_TOKEN_INVALID");if(!(null==n?void 0:n.nomo_jwt_validity_in_sec)||a.timestamp+n.nomo_jwt_validity_in_sec<o().utc().unix())throw new i(403,"AUTH_TOKEN_EXPIRED");if(r.nomo_auth_addr!==a.nomo_auth_addr)throw new i(403,"NOMO_INVALID_AUTH_ADDR");if(!(null==n?void 0:n.nomo_ignore_signature)&&!function(o,t,n){try{return e.verify(n,o,t,h.messagePrefix)}catch(o){return!1}}(r.nomo_auth_addr,r.nomo_sig,s))throw new i(403,"NOMO_INVALID_SIGNATURE")}(s,a),c()}catch(e){if(e instanceof i){const r={error_message:e.message,error_type:"API_ERROR"},i=_(s);if(403===e.status_code&&i.nomo_auth_addr){const e=n.randomBytes(15).toString("hex"),s=o().utc().unix(),_={nomo_auth_addr:i.nomo_auth_addr,nonce:e,timestamp:s};r.jwt=t.sign(_,null==a?void 0:a.nomo_jwt_secret_key)}u.status(e.status_code).json(r)}else console.log(e),u.status(500).json({error_message:e,error_type:"INTERNAL_ERROR"});u.end()}}))}}const c={nomo_jwt_secret_key:"",nomo_jwt_validity_in_sec:10800,nomo_ignore_signature:!1},h={messagePrefix:"Eurocoin Signed Message:\n",bip32:{public:76067358,private:76066276},pubKeyHash:87,scriptHash:88,wif:128,dustThreshold:1};function m(o){try{return o?t.verify(o,null==a?void 0:a.nomo_jwt_secret_key):null}catch(o){return null}}export{_ as getNomoHeaderData,s as getNomoToken,u as nomoMiddleware};
//# sourceMappingURL=index.js.map
